<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Investment Banking KIS Vietnam Offerings</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <header class="site-header">
    <img src="kis_logo.png" alt="Company Logo" class="site-logo" />
    </header>
    <h2>Investment Banking KIS Vietnam Offerings</h2>
    <p class="muted">Day count convention: ACT / 365 Fixed</p>

<div class="tabs">
  <button class="tab active" data-tab="intro">Introduction</button>
  <button class="tab" data-tab="price">Price Calculator (Given YTM)</button>
  <button class="tab" data-tab="ytm">YTM Calculator (Given Price)</button>
  <button class="tab" data-tab="transaction">Transaction Calculator</button>
</div>

<!-- INTRODUCTION TAB -->
<div id="intro-tab" class="tab-content active">
  <div class="box">
    <div id="ratesTable"></div>
  </div>
  
  <div class="box" style="margin-top: 16px;">
    <h3>Bond Offering List</h3>
    <label>Select Date (DD/MM/YYYY)</label>
    <input id="offeringDate" type="text" placeholder="DD/MM/YYYY" />
    <div id="offeringTable" style="margin-top: 16px;"></div>
  </div>
</div>

    <!-- PRICE CALCULATOR TAB -->
    <div id="price-tab" class="tab-content">
      <div class="grid">
        <div class="box">
          <h3>Inputs</h3>
          <label>Select Bond</label>
          <select id="bondSelect">
            <option value="">-- Select a bond --</option>
          </select>
          <div id="bondInfo" class="bond-info hidden"></div>
          <div id="bankRateInfo" class="bank-rate-info hidden"></div>
          <div id="recordingWarning" class="recording-warning hidden"></div>
          <label>Face value (VND)</label>
          <input id="fv" type="text" value="100.000.000" inputmode="numeric" />
          <label>Yield to maturity (% / year)</label>
          <input id="yield" type="number" value="8" step="0.01" />
          <label>Settlement date (DD/MM/YYYY)</label>
          <input id="settle" type="text" />
        </div>
        <div class="box">
          <h3>Results</h3>
          <pre id="out" class="mono">—</pre>
          <h4 style="margin-top: 16px">Cashflows (after settlement)</h4>
          <div id="cfs" class="mono muted">—</div>
        </div>
      </div>
    </div>

    <!-- YTM CALCULATOR TAB -->
    <div id="ytm-tab" class="tab-content">
      <div class="grid">
        <div class="box">
          <h3>Inputs</h3>
          <label>Select Bond</label>
          <select id="bondSelectYTM">
            <option value="">-- Select a bond --</option>
          </select>
          <div id="bondInfoYTM" class="bond-info hidden"></div>
          <div id="bankRateInfoYTM" class="bank-rate-info hidden"></div>
          <div id="recordingWarningYTM" class="recording-warning hidden"></div>
          <label>Face value (VND)</label>
          <input id="fvYTM" type="text" value="100.000.000" inputmode="numeric" />
          <label>Dirty price (VND)</label>
          <input id="price" type="text" value="100.000.000" inputmode="numeric" />
          <label>Settlement date (DD/MM/YYYY)</label>
          <input id="settleYTM" type="text" />
          <div id="ytmStatus" class="hidden"></div>
        </div>
        <div class="box">
          <h3>Results</h3>
          <pre id="outYTM" class="mono">—</pre>
          <h4 style="margin-top: 16px">Cashflows (after settlement)</h4>
          <div id="cfsYTM" class="mono muted">—</div>
        </div>
      </div>
    </div>

    <!-- TRANSACTION CALCULATOR TAB -->
  <div id="transaction-tab" class="tab-content">
    <div class="grid">
      <div class="box">
        <h3>Transaction Inputs</h3>
        <label>Select Bond</label>
        <select id="bondSelectTx">
          <option value="">-- Select a bond --</option>
        </select>
        <div id="bondInfoTx" class="bond-info hidden"></div>
        <div id="bankRateInfoTx" class="bank-rate-info hidden"></div>
        <div id="recordingWarningTx" class="recording-warning hidden"></div>
        <label>Number of bonds</label>
        <input id="numBonds" type="number" value="100" step="1" />
        <label>Leg 1 - Payment Date (Buying) (DD/MM/YYYY)</label>
        <input id="paymentDateBuying" type="text" />
        <label>Leg 1 - Discount Yield (% / year)</label>
        <input id="discountYield" type="number" value="5.5" step="0.01" />
        
        <label>Leg 2 - Expected Payment Date (Selling) (DD/MM/YYYY)</label>
        <input id="paymentDateSelling" type="text" />
        
        <label>Leg 2 - Expected Holding Interest Rate (% / year)</label>
        <input id="holdingRate" type="number" value="4.3" step="0.01" />
        
        <label class="checkbox-label">
          <input id="coverFees" type="checkbox" checked />
          Cover transaction fees and taxes
        </label>
        <label class="checkbox-label">
          <input id="institutionPurchase" type="checkbox" />
          Institution Purchase (No withholding tax on coupons)
        </label>
        </div>
        <div class="box">
          <h3>Transaction Results</h3>
          <pre id="outTx" class="mono">—</pre>

          <h4 style="margin-top: 16px">Profit Calculation</h4>
          <div id="profitTx" class="mono muted">—</div>
        </div>
      </div>
        <div class="box" style="margin-top: 16px;">
      <h3>Portfolio Value Over Time</h3>
      <div style="position: relative; height: 400px;">
        <canvas id="txChart"></canvas>
      </div>
    </div>
    </div>
<!-- 1️⃣ Chart.js FIRST -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<!-- 2️⃣ Date adapter SECOND -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

<script type="module">
  import { loadData, populateBondSelect, setTodaySettlement } from "./js/dataLoader.js";
  import { initIntroTab } from "./js/introTab.js";
  import { initPriceTab } from "./js/priceTab.js";
  import { initYTMTab } from "./js/ytmTab.js";
  import { initTransactionTab } from "./js/transactionTab.js";

  // Tab switching
  const tabs = document.querySelectorAll(".tab");
  tabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      const tabName = tab.dataset.tab;
      tabs.forEach((t) => t.classList.remove("active"));
      tab.classList.add("active");
      document.querySelectorAll(".tab-content").forEach((content) => {
        content.classList.remove("active");
      });
      document.getElementById(`${tabName}-tab`).classList.add("active");
    });
  });

  // Initialize app
  (async () => {
    try {
      const { bondsData } = await loadData();
      populateBondSelect("bondSelect", bondsData.bonds);
      populateBondSelect("bondSelectYTM", bondsData.bonds);
      populateBondSelect("bondSelectTx", bondsData.bonds);
      setTodaySettlement("settle", "settleYTM", "paymentDateBuying", "paymentDateSelling", "offeringDate");
      
      initIntroTab();
      initPriceTab();
      initYTMTab();
      initTransactionTab();
    } catch (error) {
      document.getElementById("out").textContent = "Error loading bond data. Please check JSON files.";
    }
  })();
</script>
  </body>
</html>