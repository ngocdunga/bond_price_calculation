<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bond Price Calculator (ACT/365F)</title>

    <style>
      body {
        font-family: system-ui;
        padding: 16px;
        max-width: 980px;
        margin: 0 auto;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .box {
        padding: 14px;
        border: 1px solid #ddd;
        border-radius: 14px;
      }
      label {
        display: block;
        margin-top: 10px;
        font-size: 14px;
      }
      input,
      select {
        width: 100%;
        padding: 10px;
        margin-top: 6px;
        box-sizing: border-box;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          monospace;
      }
      .muted {
        color: #666;
        font-size: 13px;
      }
      .bond-info {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 13px;
      }
      .hidden {
        display: none;
      }
      .bank-rate-info {
        background: #e3f2fd;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 13px;
      }
      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        font-size: 13px;
      }

      .table th,
      .table td {
        border: 1px solid #ddd;
        padding: 8px 10px;
        text-align: right;
      }

      .table th {
        background: #f0f0f0;
        font-weight: 600;
      }

      .table td:first-child,
      .table th:first-child {
        text-align: left;
      }

      .table tr:nth-child(even) {
        background: #fafafa;
      }

      .table caption {
        text-align: left;
        font-weight: 600;
        margin-bottom: 6px;
      }
    </style>
  </head>

  <body>
    <h2>Bond Pricing (ACT/365)</h2>
    <p class="muted">Day count convention: ACT / 365 Fixed</p>

    <div class="grid">
      <div class="box">
        <h3>Inputs</h3>

        <label>Select Bond</label>
        <select id="bondSelect">
          <option value="">-- Select a bond --</option>
        </select>

        <div id="bondInfo" class="bond-info hidden"></div>
        <div id="bankRateInfo" class="bank-rate-info hidden"></div>

        <label>Face value (VND)</label>
        <input id="fv" type="text" value="100.000.000" inputmode="numeric" />

        <div id="fixedRateInputs">
          <label>Coupon rate (% / year)</label>
          <input id="couponRate" type="number" value="10" step="0.01" />
        </div>

        <label>Yield to maturity (% / year)</label>
        <input id="yield" type="number" value="8" step="0.01" />

        <label>Coupon frequency</label>
        <select id="freq">
          <option value="1">Annual</option>
          <option value="2" selected>Semi-annual</option>
          <option value="4">Quarterly</option>
          <option value="12">Monthly</option>
        </select>

        <label>Issue date (DD/MM/YYYY)</label>
        <input id="issue" type="text" value="05/01/2026" />

        <label>Settlement date (DD/MM/YYYY)</label>
        <input id="settle" type="text" value="01/04/2026" />

        <label>Maturity date (DD/MM/YYYY)</label>
        <input id="mat" type="text" value="05/01/2029" />
      </div>

      <div class="box">
        <h3>Results</h3>
        <pre id="out" class="mono">—</pre>

        <h4 style="margin-top: 16px">Cashflows (after settlement)</h4>
        <div id="cfs" class="mono muted">—</div>
      </div>
    </div>

    <script type="module">
      import {
        vndInt,
        vnd6,
        formatVNDInput,
        parseVNDInput,
        parseDateVN,
        formatDateVN,
        priceBond,
        priceFloatingBond,
        calculateAverageBankRate,
      } from "./utils.js";

      // ================= DATA LOADING =================

      let bondsData = null;
      let bankRatesData = null;
      let selectedBond = null;

      async function loadData() {
        try {
          const [bondsResponse, bankRatesResponse] = await Promise.all([
            fetch("./bonds.json"),
            fetch("./bankRates.json"),
          ]);

          bondsData = await bondsResponse.json();
          bankRatesData = await bankRatesResponse.json();

          populateBondSelect();
        } catch (error) {
          console.error("Error loading data:", error);
          document.getElementById("out").textContent =
            "Error loading bond data. Please check JSON files.";
        }
      }

      function populateBondSelect() {
        const select = document.getElementById("bondSelect");

        bondsData.bonds.forEach((bond) => {
          const option = document.createElement("option");
          option.value = bond.code;
          option.textContent = `${bond.code}`;
          select.appendChild(option);
        });
      }

      function onBondSelect() {
        const bondCode = bondSelectEl.value;

        if (!bondCode) {
          selectedBond = null;
          bondInfoEl.classList.add("hidden");
          bankRateInfoEl.classList.add("hidden");
          fixedRateInputsEl.classList.remove("hidden");
          return;
        }

        selectedBond = bondsData.bonds.find((b) => b.code === bondCode);

        if (!selectedBond) return;

        // Update form with bond data
        fvEl.value = formatVNDInput(selectedBond.faceValue.toString());
        freqEl.value = selectedBond.frequency.toString();
        issueEl.value = selectedBond.issueDate;
        matEl.value = selectedBond.maturity;

        // Show bond info
        let info = `<strong>${selectedBond.code}</strong><br>`;
        info += `Frequency: ${selectedBond.frequency}x per year<br>`;
        info += `Issue: ${selectedBond.issueDate} | Maturity: ${selectedBond.maturity}`;

        fixedRateInputsEl.classList.add("hidden");
        info += `<br><strong>Interest Schedule:</strong><br>`;
        selectedBond.interestSchedule.forEach((s) => {
          info += `Payment ${s.payment}: ADR + ${(s.rate * 100).toFixed(
            2
          )}%<br>`;
        });

        // Show bank rate info
        const avgRate = calculateAverageBankRate(
          selectedBond.referenceBank,
          bankRatesData.rates
        );
        let bankInfo = `<strong>Reference Banks:</strong> ${selectedBond.referenceBank.join(
          ", "
        )}<br>`;
        bankInfo += `<strong>Average Deposit Rate (ADR):</strong> ${(
          avgRate * 100
        ).toFixed(3)}%<br>`;
        bankInfo += `<strong>Individual Rates:</strong><br>`;
        selectedBond.referenceBank.forEach((bank) => {
          bankInfo += `${bank}: ${(bankRatesData.rates[bank] * 100).toFixed(
            2
          )}%<br>`;
        });
        bankInfo += `<small>Last updated: ${bankRatesData.lastUpdated}</small>`;

        bankRateInfoEl.innerHTML = bankInfo;
        bankRateInfoEl.classList.remove("hidden");

        bondInfoEl.innerHTML = info;
        bondInfoEl.classList.remove("hidden");

        recalc();
      }

      // ================= RECALC =================

      function recalc() {
        const fv = parseVNDInput(fvEl.value);
        if (!fv) return;

        const y = +yEl.value;
        const freq = +freqEl.value;

        const issue = parseDateVN(issueEl.value);
        const settle = parseDateVN(settleEl.value);
        const maturity = parseDateVN(matEl.value);

        if (!issue || !settle || !maturity) {
          out.textContent = "Invalid date format (DD/MM/YYYY)";
          return;
        }

        let r;

        // Floating rate bond
        const baseBankRate = calculateAverageBankRate(
          selectedBond.referenceBank,
          bankRatesData.rates
        );

        r = priceFloatingBond({
          fv,
          ytm: y,
          freq,
          issue,
          settle,
          maturity,
          interestSchedule: selectedBond.interestSchedule,
          baseBankRate,
        });
        cfs.innerHTML = r.cfs.length
          ? `
  <table class="table">
    <thead>
      <tr>
        <th>Date</th>
        <th>#</th>
        <th>Rate</th>
        <th>Cash Flow</th>
        <th>PV</th>
      </tr>
    </thead>
    <tbody>
      ${r.cfs
        .map(
          (x) => `
        <tr>
          <td>${x.date}</td>
          <td>${x.paymentNum}</td>
          <td> ${(x.rate * 100).toFixed(3)}%</td>
          <td>${vnd6.format(x.cf)}</td>
          <td>${vnd6.format(x.pv)}</td>
        </tr>
      `
        )
        .join("")}
    </tbody>
  </table>
  `
          : "—";
        out.innerHTML = `
<table class="table">
  <tbody>
    <tr>
      <th>Prev coupon</th>
      <td>${r.prev ? formatDateVN(r.prev) : "—"}</td>
    </tr>
    <tr>
      <th>Next coupon</th>
      <td>${r.next ? formatDateVN(r.next) : "—"}</td>
    </tr>
    <tr>
      <th>Accrued interest</th>
      <td>${vndInt.format(r.accrued)}</td>
    </tr>
    <tr>
      <th>Dirty price</th>
      <td><strong>${vndInt.format(r.dirty)}</strong></td>
    </tr>
  </tbody>
</table>
`;
      }

      // ================= DOM =================

      const bondSelectEl = document.getElementById("bondSelect");
      const bondInfoEl = document.getElementById("bondInfo");
      const bankRateInfoEl = document.getElementById("bankRateInfo");
      const fixedRateInputsEl = document.getElementById("fixedRateInputs");
      const fvEl = document.getElementById("fv");
      const cEl = document.getElementById("couponRate");
      const yEl = document.getElementById("yield");
      const freqEl = document.getElementById("freq");
      const issueEl = document.getElementById("issue");
      const settleEl = document.getElementById("settle");
      const matEl = document.getElementById("mat");
      const out = document.getElementById("out");
      const cfs = document.getElementById("cfs");

      // Bond selection
      bondSelectEl.addEventListener("change", onBondSelect);

      // Auto-format Face Value
      fvEl.addEventListener("input", () => {
        const pos = fvEl.selectionStart;
        const before = fvEl.value;
        fvEl.value = formatVNDInput(before);
        const diff = fvEl.value.length - before.length;
        fvEl.setSelectionRange(pos + diff, pos + diff);
        recalc();
      });

      document
        .querySelectorAll("input:not(#bondSelect), select:not(#bondSelect)")
        .forEach((el) => el.addEventListener("input", recalc));

      // Load data on page load
      loadData();
    </script>
  </body>
</html>
