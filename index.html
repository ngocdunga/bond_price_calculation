<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bond Price Calculator (ACT/365F)</title>

<style>
body {
  font-family: system-ui;
  padding: 16px;
  max-width: 980px;
  margin: 0 auto;
}
.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
.box {
  padding: 14px;
  border: 1px solid #ddd;
  border-radius: 14px;
}
label {
  display: block;
  margin-top: 10px;
  font-size: 14px;
}
input, select {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
}
.mono {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
}
.muted {
  color: #666;
  font-size: 13px;
}
</style>
</head>

<body>
<h2>Bond Pricing (ACT/365 Fixed)</h2>
<p class="muted">Day count convention: ACT / 365 Fixed</p>

<div class="grid">
  <div class="box">
    <h3>Inputs</h3>

    <label>Face value (VND)</label>
    <input id="fv" type="text" value="1.000.000.000" inputmode="numeric" />

    <label>Coupon rate (% / year)</label>
    <input id="c" type="number" value="10" step="0.01" />

    <label>Yield to maturity (% / year)</label>
    <input id="y" type="number" value="12" step="0.01" />

    <label>Coupon frequency</label>
    <select id="freq">
      <option value="1">Annual</option>
      <option value="2" selected>Semi-annual</option>
      <option value="4">Quarterly</option>
      <option value="12">Monthly</option>
    </select>

    <label>Issue date (DD/MM/YYYY)</label>
    <input id="issue" type="text" value="05/01/2026" />

    <label>Settlement date (DD/MM/YYYY)</label>
    <input id="settle" type="text" value="01/04/2026" />

    <label>Maturity date (DD/MM/YYYY)</label>
    <input id="mat" type="text" value="05/01/2029" />
  </div>

  <div class="box">
    <h3>Results</h3>
    <pre id="out" class="mono">—</pre>

    <h4 style="margin-top:16px;">Cashflows (after settlement)</h4>
    <div id="cfs" class="mono muted">—</div>
  </div>
</div>

<script>
// ================= FORMATTERS =================

// VND – no decimals
const vndInt = new Intl.NumberFormat("vi-VN", {
  style: "currency",
  currency: "VND",
  maximumFractionDigits: 0
});

// VND – 6 decimals
const vnd6 = new Intl.NumberFormat("vi-VN", {
  style: "currency",
  currency: "VND",
  minimumFractionDigits: 6,
  maximumFractionDigits: 6
});

// ================= FACE VALUE INPUT =================

function formatVNDInput(value) {
  const digits = value.replace(/\D/g, "");
  return digits.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

function parseVNDInput(value) {
  return Number(value.replace(/[.,]/g, ""));
}

// ================= DATE PARSER (DD/MM/YYYY) =================

function parseDateVN(str) {
  if (!str) return null;

  // DD/MM/YYYY
  if (str.includes("/")) {
    const [d, m, y] = str.split("/").map(Number);
    return new Date(Date.UTC(y, m - 1, d));
  }

  // YYYY-MM-DD (fallback)
  if (str.includes("-")) {
    const [y, m, d] = str.split("-").map(Number);
    return new Date(Date.UTC(y, m - 1, d));
  }

  return null;
}

function formatDateVN(dt) {
  const d = String(dt.getUTCDate()).padStart(2, "0");
  const m = String(dt.getUTCMonth() + 1).padStart(2, "0");
  const y = dt.getUTCFullYear();
  return `${d}/${m}/${y}`;
}

// ================= DATE MATH =================

function addMonthsUTC(dt, months) {
  const y = dt.getUTCFullYear();
  const m = dt.getUTCMonth();
  const d = dt.getUTCDate();
  const tmp = new Date(Date.UTC(y, m + months, 1));
  const last = new Date(Date.UTC(tmp.getUTCFullYear(), tmp.getUTCMonth() + 1, 0)).getUTCDate();
  return new Date(Date.UTC(tmp.getUTCFullYear(), tmp.getUTCMonth(), Math.min(d, last)));
}

function actualDays(d1, d2) {
  return Math.round((d2 - d1) / (24 * 60 * 60 * 1000));
}

function yearFrac(d1, d2) {
  return actualDays(d1, d2) / 365;
}

// ================= SCHEDULE =================

function buildSchedule(issue, maturity, freq) {
  const step = 12 / freq;
  let dates = [];
  let cur = maturity;
  dates.unshift(cur);

  while (cur > issue) {
    cur = addMonthsUTC(cur, -step);
    dates.unshift(cur);
    if (dates.length > 500) break;
  }
  return dates;
}

function findPrevNext(schedule, settle) {
  let prev = null, next = null;
  for (let d of schedule) {
    if (d <= settle) prev = d;
    if (d > settle && !next) next = d;
  }
  return { prev, next };
}

// ================= PRICING =================

function priceBond({ fv, coupon, ytm, freq, issue, settle, maturity }) {
  const schedule = buildSchedule(issue, maturity, freq);
  const { prev, next } = findPrevNext(schedule, settle);

  let accrued = 0;
  if (prev && settle >= prev) {
    accrued = fv * (coupon / 100) * yearFrac(prev, settle);
  }

  let dirty = 0;
  let cfs = [];

  function df(payDate) {
    const yf = yearFrac(settle, payDate);
    const r = (ytm / 100) / freq;
    return Math.pow(1 + r, -freq * yf);
  }

  for (let i = 0; i < schedule.length; i++) {
    const payDate = schedule[i];
    if (payDate <= settle) continue;

    const prevDate = schedule[i - 1] ?? issue;
    const yf = yearFrac(prevDate, payDate);
    let cf = fv * (coupon / 100) * yf;

    if (+payDate === +maturity) cf += fv;

    const pv = cf * df(payDate);
    dirty += pv;

    cfs.push({ date: formatDateVN(payDate), yf, cf, pv });
  }

  return { dirty, clean: dirty - accrued, accrued, prev, next, cfs };
}

// ================= RECALC =================

function recalc() {
  const fv = parseVNDInput(fvEl.value);
  if (!fv) return;

  const c = +cEl.value;
  const y = +yEl.value;
  const freq = +freqEl.value;

  const issue = parseDateVN(issueEl.value);
  const settle = parseDateVN(settleEl.value);
  const maturity = parseDateVN(matEl.value);

  if (!issue || !settle || !maturity) {
    out.textContent = "Invalid date format (DD/MM/YYYY)";
    return;
  }

  const r = priceBond({ fv, coupon: c, ytm: y, freq, issue, settle, maturity });

  out.textContent =
`Prev coupon: ${r.prev ? formatDateVN(r.prev) : "—"}
Next coupon: ${r.next ? formatDateVN(r.next) : "—"}
Accrued interest: ${vndInt.format(r.accrued)}
Dirty price: ${vndInt.format(r.dirty)}
Clean price: ${vndInt.format(r.clean)}`;

  cfs.textContent = r.cfs.length
    ? r.cfs.map(x =>
        `${x.date} | CF=${vnd6.format(x.cf)} | PV=${vnd6.format(x.pv)}`
      ).join("\n")
    : "—";
}

// ================= DOM =================

const fvEl = document.getElementById("fv");
const cEl = document.getElementById("c");
const yEl = document.getElementById("y");
const freqEl = document.getElementById("freq");
const issueEl = document.getElementById("issue");
const settleEl = document.getElementById("settle");
const matEl = document.getElementById("mat");
const out = document.getElementById("out");
const cfs = document.getElementById("cfs");

// Auto-format Face Value
fvEl.addEventListener("input", () => {
  const pos = fvEl.selectionStart;
  const before = fvEl.value;
  fvEl.value = formatVNDInput(before);
  const diff = fvEl.value.length - before.length;
  fvEl.setSelectionRange(pos + diff, pos + diff);
  recalc();
});

document.querySelectorAll("input, select").forEach(el =>
  el.addEventListener("input", recalc)
);

recalc();
</script>
</body>
</html>
